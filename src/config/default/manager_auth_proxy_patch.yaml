# This patch inject a sidecar container which is a HTTP proxy for the
# controller manager, it performs RBAC authorization against the Kubernetes API using SubjectAccessReviews.
apiVersion: apps/v1
kind: Deployment
metadata:
  name: controller-manager
  namespace: system
  annotations:
    # This code is autogenerated. We do not use it, so we ignore all vulnerabilities 
    checkov.io/skip1: CKV2_K8S_6
    checkov.io/skip8: CKV_K8S_8
    checkov.io/skip9: CKV_K8S_9
    checkov.io/skip10: CKV_K8S_10
    checkov.io/skip11: CKV_K8S_11
    checkov.io/skip12: CKV_K8S_12
    checkov.io/skip13: CKV_K8S_13
    checkov.io/skip14: CKV_K8S_14
    checkov.io/skip15: CKV_K8S_15
    checkov.io/skip20: CKV_K8S_20
    checkov.io/skip22: CKV_K8S_22
    checkov.io/skip23: CKV_K8S_23
    checkov.io/skip28: CKV_K8S_28
    checkov.io/skip29: CKV_K8S_29
    checkov.io/skip30: CKV_K8S_30
    checkov.io/skip31: CKV_K8S_31
    checkov.io/skip33: CKV_K8S_33
    checkov.io/skip37: CKV_K8S_37
    checkov.io/skip38: CKV_K8S_38
    checkov.io/skip40: CKV_K8S_40
    checkov.io/skip43: CKV_K8S_43
spec:
  template:
    spec:
      containers:
      - name: kube-rbac-proxy
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - "ALL"
        image: gcr.io/kubebuilder/kube-rbac-proxy:v0.15.0
        args:
        - "--secure-listen-address=0.0.0.0:8443"
        - "--upstream=http://127.0.0.1:8080/"
        - "--logtostderr=true"
        - "--v=0"
        ports:
        - containerPort: 8443
          protocol: TCP
          name: https
        resources:
          limits:
            cpu: 500m
            memory: 128Mi
          requests:
            cpu: 5m
            memory: 64Mi
      - name: manager
        args:
        - "--health-probe-bind-address=:8081"
        - "--metrics-bind-address=127.0.0.1:8080"
        - "--leader-elect"
